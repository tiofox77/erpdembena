<?php

namespace Database\Seeders;

use Illuminate\Database\Seeder;
use Spatie\Permission\Models\Permission;
use Spatie\Permission\Models\Role;

class MRPPermissionsSeeder extends Seeder
{
    /**
     * Run the database seeds.
     */
    public function run(): void
    {
        // Reset cached roles and permissions
        app()[\Spatie\Permission\PermissionRegistrar::class]->forgetCachedPermissions();

        // MRP Module Permissions
        $mrpPermissions = [
            // Production Scheduling
            'mrp.scheduling.view',
            'mrp.scheduling.create',
            'mrp.scheduling.edit',
            'mrp.scheduling.delete',
            'mrp.scheduling.approve',
            
            // Resources Management
            'mrp.resources.view',
            'mrp.resources.manage',
            
            // Shifts Management
            'mrp.shifts.view',
            'mrp.shifts.manage',
            
            // Lines Management
            'mrp.lines.view',
            'mrp.lines.manage',
            
            // Inventory Levels
            'mrp.inventory.view',
            'mrp.inventory.manage',
            
            // Reports
            'mrp.reports.view',
            'mrp.reports.export',
            
            // Settings
            'mrp.settings.manage',
        ];


        // Create permissions in database
        foreach ($mrpPermissions as $permission) {
            Permission::firstOrCreate(['name' => $permission], ['guard_name' => 'web']);
        }

        // Assign permissions to roles
        $superAdmin = Role::where('name', 'super-admin')->first();
        $admin = Role::where('name', 'admin')->first();
        $manager = Role::where('name', 'manager')->first();
        $planner = Role::where('name', 'production-planner')->first();
        $supervisor = Role::where('name', 'production-supervisor')->first();
        $operator = Role::where('name', 'operator')->first();
        $viewer = Role::where('name', 'viewer')->first();

        // NOTA: Criação automática de roles desativada
        // Para criar roles modulares, use o Gerenciador de Permissões em /admin/permissions-manager

        // Assign all MRP permissions to super-admin
        if ($superAdmin) {
            $superAdmin->givePermissionTo($mrpPermissions);
        }

        // Admin gets all MRP permissions except settings
        if ($admin) {
            $adminPermissions = array_filter($mrpPermissions, function($permission) {
                return $permission !== 'mrp.settings.manage';
            });
            $admin->givePermissionTo($adminPermissions);
        }

        // NOTA: Atribuição de permissões às roles desativada
        // As roles modulares devem ser criadas manualmente via interface administrativa
    }
}
